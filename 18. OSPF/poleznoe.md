# OSPF
_ _ _
OSPF (англ. Open Shortest Path First) — протокол динамической маршрутизации, основанный на технологии отслеживания состояния канала (link-state technology) и использующий для нахождения кратчайшего пути алгоритм Дейкстры.
  
В Link-state протоколах каждый маршрутизатор должен непросто знать самые лучшие маршруты во все удалённые сети, но и иметь в памяти полную карту сети со всеми существующими связями между другими маршрутизаторами в том числе. Это достигается за счет построения специальной базы LSDB
  
Маршрутизаторы, использующие OSPF, обмениваются сообщениями для
передачи информации о маршрутизации с использованием пяти типов
пакетов: 
- пакет приветствия (hello) - выполняет обнаружение соседних узлов и устанавливает отношения смежности между ними
- пакет описания базы данных (DBD) - проверяет синхронизацию баз данных между маршрутизаторами
- пакет состояния канала (LSR) - запрашивает записи о состояниях определенных каналов на различных маршрутизаторах
- пакет обновления состояния канала (LSU) - отправляет запрашиваемые записи о состоянии канала
- пакет подтверждения состояния канала (LSAck) - подтверждает другие типы пакетов
  
<image src="https://github.com/LLlMEJIb87/OTUS-learning/blob/master/18.%20OSPF/komponenti.PNG">
  
Ниже приведены шаги, которые выполняются маршрутизатором
1. Установление отношений смежности с соседними устройствами, чтоб соседство состоялось важно, чтобы в конфигурации OSPF на обоих маршрутизаторах были одинаковыми следующие параметры:
- Hello Interval — частота отправки сообщений Hello
- Router Dead Interval — период времени, по прохождению которого, сосед считается недоступным, если не было Hello.
- Area ID — соседство может установится только посредством интерфейсов в одной зоне.
- Authentication — пароль использующийся для аутентификации и тип аутентификации, если он есть.
2. Обмен объявлениями о состоянии каналов
3. Создание базы данных состояния связи
4. Исполнение алгоритма SPF
5. Выбор лучшего маршрута
  
<image src="https://github.com/LLlMEJIb87/OTUS-learning/blob/master/18.%20OSPF/sostoyania.PNG">
  
Включение и конфигурация OSPF на маршрутизаторе режим point-to-point:
1. Router ospf process-id (может быть любым от 1 до 65535, рекомендуется присваевать один и тот номер процесса всем маршрутизаторам OSPF)
2. Router-id rid ( задать индентификатор в ручную используя 32 битный адрес ipv4, если не задавать то id будет адрес loopback интерфейса)

Способ 1:
```
R1(config)#router ospf 1 - включили OSPF на маршрутизаторе
R1(config-router)#router-id 1.1.1.1 - задали идентификатор
R1(config-router)#passive-interface default - перевели все интерфейсы в пассивный режим (делается в сторону клиентов)
R1(config-router)#no passive-interface g0/0 - отключили пассивный режим на пограничных интерфейсах
R1(config-router)#no passive-interface g0/1
R1(config-router)#network 192.168.1.0 0.0.0.255 area 0 - задали на каком интерфейсе включить процесс OSPF, указав сети привязанные к интерфейсу
R1(config-router)#network 10.0.1.0 0.0.0.255 area 0 
R1(config-router)#network 10.0.2.0 0.0.0.255 area 0
R1(config)#exit
R1(config)#interface range g0/0-1
R1(config-if-range)#ip ospf network point-to-point - указали, что интерфейсы используются для подключения к другим маршрутизаторам.
```

Способ 2:
```
R2(config)#router ospf 1 - включили OSPF на маршрутизаторе
R2(config-router)#router-id 2.2.2.2 - задали идентификатор
R2(config-router)#network 10.0.1.2 0.0.0.0 area 0 - задали на каком интерфейсе включить процесс OSPF, указав ip интерфейса
R2(config-router)#network 10.0.1.2 0.0.0.0 area 0 
```
  
Cпособ 3:
```
R3(config)#router ospf 1 включили OSPF на маршрутизаторе
R3(config-router)#router-id 3.3.3.3 задали идентификатор
R3(config-router)#exit
R3(config)#interface gigabitEthernet 0/2 
R3(config-if)#ip ospf 1 area 0 - включили интерфейс в процесс OSPF
R3(config)#exit
R3(config)#interface gigabitEthernet 0/1
R3(config-if)#ip ospf 1 area 0
R3(config-if)#exit
R3(config)#interface gigabitEthernet 0/0
R3(config-if)#ip ospf 1 area 0
```

```
R3#show ip ospf neighbor - покажет граничиющие маршрутизаторы (отношение смежности OSPF)
```

### OSPF сеть с коллективным доступом.
  
<p align="center">
<image src="https://github.com/LLlMEJIb87/OTUS-learning/blob/master/18.%20OSPF/broadcast_ospf.PNG">
</p>
  
Сети OSPF с коллективным доступом уникальны тем, что один маршрутизатор управляет распределение LSA. Маршрутизатор выбранной для этой роли, должен быть определен администратором сети с помощью правильной настройки.
  
Назначеный маршрутизатор OSPF:
- В сетях с множественным доступом OSPF выбирает DR и BDR. DR
отвечает за сбор и распространение отправленных и полученных LSAs.
DR использует IPv4-адрес многоадресной рассылки 224.0.0.5, который
предназначен для всех маршрутизаторов OSPF.
- На случай сбоя выделенного маршрутизатора (DR) также выбирается
резервный назначенный маршрутизатор (BDR). Маршрутизатор BDR
пассивно наблюдает за этим обменом и поддерживает отношения со
всеми маршрутизаторами. Если DR перестает создавать пакеты
приветствия (hello), то BDR самостоятельно принимает роль DR.
- Остальные маршрутизаторы, не являющиеся DR или BDR, станут
маршрутизаторами DROTHER (маршрутизатор, которые не являются
ни DR, ни BDR). DROTHERs используют адрес многоадресной
рассылки 224.0.0.6 (все назначенные маршрутизаторы) для отправки
пакетов OSPF в DR и BDR. Только DR и BDR прослушивают 224.0.0.6.

```
R1#show ip ospf interface g0/0/0 - покажет роль маршрутизатора
```
  
Процесс выбора DR/BDR по умолчанию
Выбор ролей DR и BDR по протоколу OSPF основывается на следующих критериях
в указанной очередности:
1. Маршрутизаторы в сети выбирают маршрутизатор с самым высоким
приоритетом интерфейса в качестве DR. Маршрутизатор со вторым по величине
приоритетом интерфейса становится BDR.
- Приоритет может быть представлен любым числом от 0 до 255.
- Если значение приоритета интерфейса равно 0, этот интерфейс не может быть выбран
как DR или BDR.
- Приоритет по умолчанию интерфейсов, подключенных к широковещательной сети
множественного доступа, равен 1.
2. Если приоритеты интерфейсов равны, то в качестве DR будет выбран
маршрутизатор с наивысшим идентификатором. Маршрутизатор со вторым по
величине идентификатором становится BDR.
• Процедура выбора DR и BDR начинается сразу после появления в сети с
коллективным доступом первого активного маршрутизатора с интерфейсом, где
включен OSPF. Если в сети с множественным доступом загрузились не все
маршрутизаторы, то роль DR может получить маршрутизатор не с самым
высоким идентификатором.
• Добавление нового маршрутизатора не приводит к новому процессу выбора.
  
```
R1(config)#interface g0/0/0
R1(config-if)#ip ospf priority 255 - изменяем приоретет интерфейса
R1(config-if)#end
R1#clear ip ospf process - сброс процесса OSPF
```


### Значение метрики OSPF в Cisco устройствах
  

- Следует помнить, что протокол маршрутизации использует метрику для
определения оптимального пути пакета в сети. Протокол OSPF использует
стоимость в качестве метрики. Путь с более низкой стоимостью является
оптимальным по сравнению с путём с более высокой стоимостью.
- Стоимость интерфейса обратно пропорциональна его пропускной способности.
Следовательно, более высокая пропускная способность указывает на более низкую
стоимость. Формула расчёта стоимости OSPF:
Стоимость = эталонная пропускная способность / пропускная способность
интерфейса
- Заданная пропускная способность равна по умолчанию 108
(100000000). Таким
образом, используется следующая формула расчета:
Стоимость = 100 000 000 бит/с /пропускная способность интерфейса в бит/с
- Значение стоимости должно быть целым числом. При получении в
результате расчёта числа, которое меньше целого числа, протокол OSPF
округляет его до ближайшего целого числа. Таким образом, стоимость
OSPF, назначенная интерфейсу Gigabit Ethernet с базовой пропускной
способностью по умолчанию 100 000 000 бит/с, будет равна 1, так как
ближайшее целое число для 0.1 равно 0, а не 1.
Стоимость = 100 000 000 бит/с/1 000 000 000 000 = 1
- По этой причине все интерфейсы быстрее, чем Fast Ethernet, будут иметь
ту же стоимость, что и интерфейс Fast Ethernet.
- Чтобы протокол OSPF правильно определил путь, необходимо изменить
эталонную пропускную способность, задав более высокое значение с
учетом сетей, содержащих каналы, скорость которых выше 100 Мбит/с.

```
R1(config)#router ospf 1
R1(config-router)#auto-cost reference-bandwidth 1000 - позволяет настроить эталонную полосу пропускания на маршрутизаторе
```
```
ip ospf cost - задает значени стоимости в ручную на необходимых интерфейсах.
```

### Интерваллы Hello и Dead - 
Интерваллы hello ( 10 каждые 10 секунд) и простоя dead (40 секунд) по умолчанию основаны на практических рекомендациях и могут быть изменены лишь в крайних случаях:|
```
R1(config)#interface g0/0/0
R1(config-if) ip ospf hello-interval 5
R1(config-if) ip ospf dead-interval 20
```
Если менять интервалы, то нужно менять на всех интерфейсах

### Маршрут по умолчанию в OSPF
На пограничном ( с интернет) маршрутизаторе производят следующие настройки:
```
R1(config)#router ospf 1
R1(config-router)#default-information originate
```
```
R1# show ip protocols - быстрый способ проверки важнейшей информации о конфигурации OSPF
```
```
R1# show ip ospf interface g0/0/0 - покажет настройки на выбранном интерфейсе
```
```
R1# show ip ospf interface brief - сводные данные об интерфейсах OSPF
```