# ПРОТОКОЛ STP
_ _ _
Spanning Tree Protocol — протокол канального уровня, основной задачей которого является предотвращение петель, путём отключения избыточных линков.
  
STP использует алгоритм STA (Spanning Tree Algorithm), результатом работы которого является граф в виде дерева (связный и без простых циклов). Он создает один логический путь через коммутационную сеть.
  
Чтобы создать один логический путь, протокол STP отправляет блоки данных BPDU (Bridge Protocol Data Units) между устройтсвами . Коммутаторы шлют BPDU из всех работающих портов на мультикастовый ethernet-адрес 01-80-c2-00-00-00 (по умолчанию каждые 2 секунды), который прослушивают все свичи с включенным STP. BPDU бывают двух видов: конфигурационные (Configuration BPDU) и панические “ААА, топология поменялась!” TCN (Topology Change Notification BPDU). Первые регулярно рассылаются корневым свичом (и ретранслируются остальными) и используются для построения топологии, вторые, как понятно из названия, отсылаются в случае изменения топологии сети (проще говоря, подключении\отключении свича). Конфигурационные BPDU содержат несколько полей, остановимся на самых важных:
- Идентификатор отправителя (Bridge ID)
- Идентификатор корневого свича (Root Bridge ID)
- Идентификатор порта, из которого отправлен данный пакет (Port ID)
- Стоимость маршрута до корневого свича (Root Path Cost)
  
Термины:
1. Корневой коммутатор - от него строится древовидная топология
2. Корневой (Root) порт - это порт, который имеет наименьшую стоимость до корневого коммутатора
3. Назначенный (Designated) порт - некорневой” порт коммутатора между сегментами сети, принимающий трафик из соответствующего сегмента. Выбиратеся для каждого сегмента (канала) исходя из стоимости возврата к корневому мосту для дбой стороны канала.
4. Альтернативный порт - резервный порт для designated порта, если другая сторона не является root портом
5. Резервный порт - запасной порт для root порта
  
Алгоритм STA
1. Коммутатор с наименьшим Bridge id (BID) становится корневым мостом. Изначально каждый коммутатор считает себя root, после обмена PBDU строится дерево
- значение приорета BID по умолчанию 32768 (можно менять в ручную)
- при одинаковым приорете коммутаторов, rootом становится коммутатор с наименьшим значением MAC
2. Стоимость корневого пути используется для определения роли порта
- стоимость порта (можно менять в ручную)
- учитывается приоретет порта, при одинаковой стоимости
3. Состояние портов
- block - блокирующий режим ( может получать и обрабатывать BPDU)
- listening - режим прослушивания  (порт слушает и начинает сам отправлять BPDU, кадры с данными не отправляет)
- learning - режим обучения (порт слушает и отправляет BPDU, а также вносит изменения в CAM- таблицу, но данные не перенаправляет)
- Forwarding- режим пересылки ( этот может все: и посылает\принимает BPDU, и с данными оперирует, и участвует в поддержании таблицы mac-адресов. То есть это обычное состояние рабочего порта)
4. Режим порта
- portfast при подключении устройства к такому порту, он, минуя промежуточные стадии, сразу переходит к forwarding-состоянию. Само собой, portfast следует включать только на интерфейсах, ведущих к конечным устройствам (рабочим станциям, серверам, телефонам и т.д.), но не к другим свичам.
  
  
Более подробно можно изучить по ссылке https://linkmeup.ru/blog/1192/